Noid for php
============

[Noid for Php] is a tool to create and manage temporary or permanent nice opaque
identifiers ([noid]) for physical or digital objects or anything else like "12025/654xz321".

This is the php version of a [perl tool] of 2002-2006, still largely used in
libraries, museums and any institution that manage collections and archives, for
example the University of California, the Internet Archive, or the Bibliothèque
nationale de France.

The main goal of this version is for web services, that can create and manage
standard noids without any dependancy. All commands and functions can be used as
in the Perl version, via the command line or via the web.

It is already implemented in [Omeka] and [Omeka S], an open source CMS designed
to expose digitalized documents, via the addons [Ark & Noid for Omeka] and
[Ark for Omeka S].

Other versions exist in [Java] and [Ruby].


Noid Overview
-------------

The noid utility creates minters (identifier generators) and accepts commands
that operate them. Once created, a minter can be used to produce persistent,
globally unique names for documents, databases, images, vocabulary terms, etc.
Properly managed, these identifiers can be used as long term durable information
object references within naming schemes such as ARK, PURL, URN, DOI, and LSID.
At the same time, alternative minters can be set up to produce short-lived names
for transaction identifiers, compact web server session keys, and other
ephemera.

In general, a noid minter efficiently generates, tracks, and binds unique
identifiers, which are produced without replacement in random or sequential
order, and with or without a check character that can be used for detecting
transcription errors. A minter can bind identifiers to arbitrary element names
and element values that are either stored or produced upon retrieval from
rule-based transformations of requested identifiers; the latter has application
in identifier resolution. Noid minters are very fast, scalable, easy to create
and tear down, and have a relatively small footprint. They use BerkeleyDB as the
underlying database.

Identifiers generated by a noid minter are also known as "noids" (nice opaque
identifiers -- rhymes with void). While a minter can record and bind any
identifiers that you bring to its attention, often it is used to generate,
bringing to your attention, identifier strings that carry no widely recognizable
meaning. This semantic opaqueness reduces their vulnerability to era- and
language-specific change, and helps persistence by making for identifiers that
can age and travel well.

See the full description, tutorial and usage on [metacpan], and the list
of available [commands].


Installation
------------

Since version 1.2.0, the tool is a library managed by composer, so just install
it via `composer require daniel-km/noid4php` and add `require_once "vendor/autoload.php`
to your project.

Else, simply include the file "lib/Noid.php" in your project and the class "Noid"
will be available. The command line tool is available via "noid.php" or the
symbolic link "noid", but is not required.

Since version 1.2.0, the data can be stored in a selected base:

- **lmdb** (Lightning Memory-Mapped Database), that requires the php extension
  "dba" with the "lmdb" handler. **This is the new default since version 1.3.**
  LMDB is the recommended replacement for BerkeleyDB and is available on all
  modern Linux distributions (Debian 10+, Redhat and their derivatives).
- **sqlite**, that requires the php extension "sqlite3", that stores the data in
  a single file. Good for portable installations.
- **xml**, that requires the php extension "xml", that is a human-readable file.
  Suitable for long-term storage, easy backup, and data export/import between
  systems.
- **mysql/mariadb**, that requires the php extension "mysql" or "mysqli".
- **Berkeley database** (bdb), that was the original native base of this tool.
  It requires the php extension "dba" with the "db4" handler. **Note:** The db4
  handler is no longer available on most modern Linux distributions (see
  [BerkeleyDB/db4 deprecation](#berkeleydbdb4-deprecation) below). Use only on
  older systems.

The config can be set when instantiating a class or passing it via the option -f
of noid with the path to the config file (default is config/settings.php).

### Perl and php

The output of perl (release 5.20 and greater) and php (before and since release
7.1, where the output of `rand()` and `srand()` were [fixed] in the php
algorithm), are the same for integers at least until 32 bits (perl limit, namely
more than 4 000 000 000 identifiers).

**For float numbers, the output is different after the 8192nd value**, so keep
the same language.

Anyway, it is recommended to use php 7.1 or higher, since previous versions of
php are no more supported.

### Automatic test

[PhpUnit] (version 6 or higher) can be used to check the installation via the
command `phpunit` at the root of the tool. Note that the full series of tests
are long, a few dozen of minutes, because the process compares the outputs of
php methods and  perl ones for many seeds.

If you don’t have phpunit, you can do:

```sh
wget https://phar.phpunit.de/phpunit-7.4.phar
# Quick tests with php 7.1 to php 7.4.
php phpunit-7.4.phar
# Full tests (fail for float numbers above 8192).
php phpunit-7.4.phar tests/PerlRandom
```

The version 1.1.2 is compatible from php 5.6 to php 7.4.
The version 1.2.0 is compatible from php 7.1 to php 7.4.

### BerkeleyDB/db4 deprecation

The original Noid tool uses BerkeleyDB as its native database, accessed through
PHP's DBA extension with the "db4" handler. However, **the db4 handler is being
phased out on recent Linux distributions**.

**Why db4 is being removed:**

In 2013, Oracle changed the BerkeleyDB license from the Sleepycat License (a
permissive open-source license) to the GNU Affero General Public License (AGPL).
This license change had significant implications for Linux distributions and
software that embedded BerkeleyDB, leading to its gradual removal.

**Debian/Ubuntu status:**

The db4 handler was removed starting with **PHP 8.x packages** in Debian
Bookworm. If you are running Debian 11 Bullseye with PHP 7.4, the db4 handler
is available from the official Debian repositories. Next versions from Debian 12
does not support db4, because php is compiled without argument `--with-db4`.

**Note:** The [Sury repository](https://deb.sury.org) (deb.sury.org), which
provides newer PHP versions for Debian, compiles PHP 8.x **without db4
support**. Installing php8.x-dba from Sury does not provide the db4 handler.

**LMDB on Debian:** The LMDB handler is compiled by default (`--with-lmdb`) in
php-dba since Debian 10 Buster (PHP 7.3). All Debian versions (10, 11, 12) include
`liblmdb0` as a dependency of php-dba, so LMDB is directly usable without any
additional configuration.

You can check available handlers with:
`php -r "print_r(dba_handlers());"`

**Red Hat/CentOS/RHEL:** The libdb package is deprecated in RHEL 9 and removed
in RHEL 10. More importantly, the official RHEL php-dba package is compiled
**without** the `--with-db4` flag, so the db4 handler is not available even on
systems where libdb is present. However, LMDB (`--with-lmdb`) is enabled by
default in RHEL's php-dba. Fedora includes both db4 and lmdb handlers.

Verify available handlers on your system with:
`php -r "print_r(dba_handlers());"`

**Available alternatives:**

1. **LMDB**: Recommended replacement for BerkeleyDB. Fast key-value store with
   similar performance characteristics. Available by default in php-dba on
   Debian (since 10), RHEL, and Fedora - no additional packages required.
   Set `'db_type' => 'lmdb'` in your settings.

2. **SQLite**: Portable, no external dependencies, works on all platforms.
   Set `'db_type' => 'sqlite'` in your settings.

3. **XML**: Human-readable format, suitable for long-term storage, easy backup,
   and data export/import between systems.
   Set `'db_type' => 'xml'` in your settings.

4. **PDO (MySQL, PostgreSQL, SQLite)**: Unified SQL backend using PDO extension.
   More portable than mysqli, supports multiple database engines.
   Set `'db_type' => 'pdo'` and configure the `driver` option in your settings:
   ```php
   'pdo' => [
       'driver' => 'mysql',  // or 'pgsql', 'sqlite'
       'data_dir' => '/path/to/data',
       'host' => 'localhost',
       'user' => 'noid',
       'password' => 'secret',
       'db_name' => 'noid',
   ],
   ```

5. **MySQL/MariaDB (deprecated)**: Legacy backend using mysqli extension.
   Use PDO instead (`'db_type' => 'pdo'` with `'driver' => 'mysql'`).

6. **Compile PHP with db4**: If you specifically need BerkeleyDB support, you
   must compile PHP from source with the `--with-db4` flag and install
   libdb5.3-dev package. Or use a distribution that uses this argument by
   default.

### Migration from BerkeleyDB to LMDB

If you have existing Noid databases in BerkeleyDB format, there are two
approaches to migrate to LMDB depending on your situation.

#### Method 1: Using `noid dbimport` (db4 handler still available)

If your system still has the db4 handler available (e.g., Debian 11 before
upgrading), use the built-in migration command:

```bash
# 1. Create the destination LMDB database
./noid -t lmdb dbcreate .zd

# 2. Import data from BerkeleyDB to LMDB
./noid -t lmdb dbimport bdb

# 3. Verify the migration
./noid -t lmdb dbinfo

# 4. Update your settings.php to use 'db_type' => 'lmdb'
```

**Note:** The `dbimport` command requires:
- The destination database to exist (created with `dbcreate`)
- The PHP db4 handler to read the source database

#### Method 2: Using migration scripts (db4 handler NOT available)

If your system no longer has the db4 handler (Debian 12+, RHEL 10+), use the
migration scripts provided in the `scripts/` directory. These scripts read
BerkeleyDB files using system tools (not PHP) and restore them to LMDB.

**Scripts provided:**

| Script                   | Language | Description                               |
|--------------------------|----------|-------------------------------------------|
| `import_from_dump.php`   | PHP      | Restores LMDB from db_dump output or JSON |
| `export_bdb_to_json.py`  | Python   | Exports BerkeleyDB to JSON                |
| `export_bdb_to_json.pl`  | Perl     | Exports BerkeleyDB to JSON                |

**Option A: Using db_dump (recommended)**

The `db_dump` utility from the `db-util` package can read BerkeleyDB files
without PHP:

```bash
# 1. Install db-util
sudo apt install db-util          # Debian/Ubuntu
sudo dnf install libdb-utils      # RHEL/Fedora

# 2. Create a text dump of your database
db_dump -p /path/to/datafiles/NOID/noid.bdb > noid_dump.txt

# 3. Check system requirements
php scripts/import_from_dump.php --check

# 4. Restore to LMDB (creates noid.lmdb automatically)
php scripts/import_from_dump.php noid_dump.txt /path/to/datafiles/NOID

# 5. Update your settings.php to use 'db_type' => 'lmdb'
```

**Option B: Using Python**

If `db_dump` doesn't work (version mismatch), use Python with bsddb3:

```bash
# 1. Install Python bsddb3
sudo apt install python3-bsddb3   # Debian/Ubuntu
pip3 install bsddb3               # Or via pip

# 2. Export to JSON
python3 scripts/export_bdb_to_json.py /path/to/noid.bdb noid_data.json

# 3. Restore to LMDB
php scripts/import_from_dump.php --json noid_data.json /path/to/datafiles/NOID
```

**Option C: Using Perl**

```bash
# 1. Install Perl modules
sudo apt install libberkeleydb-perl libjson-perl   # Debian/Ubuntu

# 2. Export to JSON
perl scripts/export_bdb_to_json.pl /path/to/noid.bdb noid_data.json

# 3. Restore to LMDB
php scripts/import_from_dump.php --json noid_data.json /path/to/datafiles/NOID
```

**Option D: Using Docker**

If none of the above work, use a Docker container with an older Debian:

```bash
# Run a Debian 11 container with your data mounted
docker run -it --rm -v /path/to/datafiles:/data debian:bullseye bash

# Inside the container
apt update && apt install -y php-cli php-dba
cd /data/NOID

# Use Method 1 (dbimport) inside the container
```

#### Key differences between methods

| Aspect                 | `noid dbimport`          | `import_from_dump.php`          |
|------------------------|--------------------------|---------------------------------|
| Creates destination DB | No (requires `dbcreate`) | **Yes** (creates automatically) |
| Requires db4 handler   | **Yes**                  | No                              |
| Input source           | PHP db4 handler          | Text file (dump/JSON)           |
| Works on Debian 12+    | No                       | **Yes**                         |

#### Migration script options

```bash
# Check system requirements
php scripts/import_from_dump.php --check

# Show help for creating dump files
php scripts/import_from_dump.php --dump-help

# Dry run (parse file without importing)
php scripts/import_from_dump.php -n noid_dump.txt /path/to/NOID

# Verbose mode
php scripts/import_from_dump.php -v noid_dump.txt /path/to/NOID

# Import from JSON file
php scripts/import_from_dump.php --json noid_data.json /path/to/NOID
```


Enhancements
------------

[Noid for Php] enhances some points present in the todo list of the Perl script.

- Added the command get_note() to get a user note.
- Added support for alphabets until 89 characters. The character repertoires are:
    - Standard:
        - `d`: `{ 0-9 x }` cardinality 10
        - `e`: `{ 1-9 b-z }` - `{l, vowels}` cardinality 29
    - Proposed:
        - `i`: `{ 0-9 x }` cardinality 11
        - `x`: `{ 0-9 a-f _ }` cardinality 17
        - `v`: `{ 0-9 a-z _ }` cardinality 37
        - `E`: `{ 1-9 b-z B-Z }` - `{l, vowels}` cardinality 47
        - `w`: `{ 0-9 a-z A-Z # * + @ _ }` cardinality 67
    - Proposed, but not accepted for Ark:
        - `c`: Visible ASCII - `{ % - . / \ }` cardinality 89
    - Not proposed in the Perl script, but compatible with Ark and useful
    because the longest with only alphanumeric characters:
        - `l`: `{ 0-9 a-z A-Z }` - `{ l }` cardinality 61


About the port
--------------

### Main purpose

The main purpose of this first conversion is the fidelity to the structure of
the original Perl script: each method has the equivalent code in perl and php
scripts. Furthermore, no dependency is added: the script can be run directly. Of
course, the performance is lower, mainly because the access to the database is
slower: only the generic functions are used, not the ones specific to Berkeley.

### Random noids

When the template is a random one, the order of generated noids is different
between the perl and the php script, because the pseudo-random generated by
these languages are different and in some cases dependent of the platform too.
In Perl, before 5.20.0 (May 2014), rand() calls drand48(), random() or rand()
from the C library stdlib.h in that order. Since 5.20.0, drand48() is
implemented. In Php, rand() uses the underlying C library’s rand (see [rosettacode.org]).

So, the process uses an emulator of the rand() function based on the ground of
the C code (PerlRandom). The use of the Perl rand() is possible via the class
Noid. Anyway, the result will be the same.

### Database

 - Only generic features of database are managed: no environment, no alarm for
 locking. Furthermore, the locking mechanism is different between perl and php,
 so don’t use them at the same time.
 - Php can read and write databases created with the perl script, but the perl
 script cannot access php ones. There is a workaround: copy the three files
 "__db.001", "__db.002" and "__db.003" in the directory "NOID". They come from a
 freshly created minter and are provided with the module in the directory
 "bdbfiles". No advanced check had been done for cross-writing databases.
 - If php and perl are used, the template must not be a random one, because
 seeds are not the same and generated ids are ordered differently.
 - In the php version, the elements can’t be duplicated: dba_replace() is
 systematically used instead of dba_insert(). Anyway, this feature is not
 available in the perl script.
 - In Perl script, $noid is a pointer to data managed from $dbname. To avoid
 this direct access to memory, harder to maintain in a high level language,
 $noid is the $dbname, that points internally to the db handle.

### To do

- [x] Optimize structure and process, but keep inputs, calls, and outputs.
- [ ] Seperate creation of noids and management of bindings.
- [x] Use other standard or flat db engines (mysql and simple file).
- [ ] See other todo in the perl or php scripts.
- [ ] Normalize classes (no false, but null, args, return types, etc.)
- [ ] Make bin noid as composer
- [ ] Better xml format and sql table (no reserved root, separate type, date, owner and value, etc.)


Warning
-------

Use it at your own risk.

It’s always recommended to backup your files and your databases and to check
your archives regularly so you can roll back if needed.

For long term noids, all events are saved in a log too.


Troubleshooting
---------------

See online issues on the [issues] page.


License
-------

* The original tool has been published by the University of California under the
BSD licence.

Permission to use, copy, modify, distribute, and sell this software and its
documentation for any purpose is hereby granted without fee, provided that (i)
the above copyright notices and this permission notice appear in all copies of
the software and related documentation, and (ii) the names of the UC Regents and
the University of California are not used in any advertising or publicity
relating to the software without the specific, prior written permission of the
University of California.

THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, EXPRESS,
IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF
MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

IN NO EVENT SHALL THE UNIVERSITY OF CALIFORNIA BE LIABLE FOR ANY SPECIAL,
INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED
OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT OF OR
IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

* The php version is published under the [CeCILL-B v1.0], compatible with the
BSD one.

The exercising of this freedom is conditional upon a strong obligation of giving
credits for everybody that distributes a software incorporating a software ruled
by the current license so as all contributions to be properly identified and
acknowledged.

In consideration of access to the source code and the rights to copy, modify and
redistribute granted by the license, users are provided only with a limited
warranty and the software’s author, the holder of the economic rights, and the
successive licensors only have limited liability.

In this respect, the risks associated with loading, using, modifying and/or
developing or reproducing the software by the user are brought to the user’s
attention, given its Free Software status, which may make it complicated to use,
with the result that its use is reserved for developers and experienced
professionals having in-depth computer knowledge. Users are therefore encouraged
to load and test the suitability of the software as regards their requirements
in conditions enabling the security of their systems and/or data to be ensured
and, more generally, to use and operate it in the same conditions of security.
This Agreement may be freely reproduced and published, provided it is not
altered, and that no provisions are either added or removed herefrom.

* Contains PerlRandom, published under the [CeCILL-C v1.0].


Copyright
---------

- Author:  John A. Kunze, jak@ucop.edu, California Digital Library
- Originally created Nov. 2002 at UCSF Center for Knowledge Management
- Ported to php by Daniel Berthereau for Mines ParisTech

- Copyright (c) 2002-2006 UC Regents
- Copyright (c) 2016-2019 Daniel Berthereau (see [Daniel-KM] on GitLab)


[Noid for Php]: https://gitlab.com/Daniel-KM/Noid4Php
[noid]: https://wiki.ucop.edu/display/Curation/NOID
[perl tool]: http://search.cpan.org/~jak/Noid-0.424/
[Omeka]: https://www.omeka.org
[Omeka S]: https://www.omeka.org/s
[Ark & Noid for Omeka]: https://gitlab.com/Daniel-KM/Omeka-plugin-ArkAndNoid
[Ark for Omeka S]: https://gitlab.com/Daniel-KM/Omeka-S-module-Ark
[Java]: https://confluence.ucop.edu/download/attachments/16744482/noid-java.tar.gz
[Ruby]: https://github.com/microservices/noid
[metacpan]: https://metacpan.org/pod/distribution/Noid/noid
[commands]: https://metacpan.org/pod/Noid
[fixed]: https://secure.php.net/manual/en/migration71.incompatible.php#migration71.incompatible.fixes-to-mt_rand-algorithm
[PhpUnit]: https://phpunit.de
[rosettacode.org]: https://rosettacode.org/wiki/Random_number_generator_%28included%29#Perl
[issues]: https://gitlab.com/Daniel-KM/Noid4Php/issues
[CeCILL-B v1.0]: https://www.cecill.info/licences/Licence_CeCILL-B_V1-en.txt
[CeCILL-C v1.0]: https://www.cecill.info/licences/Licence_CeCILL-C_V1-en.txt
[Daniel-KM]: https://gitlab.com/Daniel-KM "Daniel Berthereau"
